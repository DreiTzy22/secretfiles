<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DigiBooth</title>
  <link rel="icon" type="image/png" href="capybara/cute-capibara-character-different-poses.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --pink-light: #fff0f5;
      --pink-mid: #ffc0d9;
      --pink-accent: #ff85b3;
      --pink-dark: #e91e8c;
      --pink-soft: #ffe4ec;
      --white: #fffafc;
      --text: #5c3a4a;
      --shadow: rgba(233, 30, 140, 0.15);
      /* Capybara / chill nature */
      --capybara-brown: #8B7355;
      --capybara-dark: #6B5344;
      --capybara-sage: #9CAF88;
      --capybara-grass: #7CB342;
      --capybara-warm: #A0826D;
      /* Nursing / care */
      --nursing-blue: #64B5F6;
      --nursing-light: #B3E5FC;
      --nursing-soft: #E3F2FD;
      --nursing-red: #E57373;
      --nursing-teal: #4DB6AC;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(165deg, #fff5f9 0%, #ffe4ef 25%, #E8F5E9 50%, #E3F2FD 75%, #ffd6e8 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        url('capybara/cute-capibara-character-different-poses.png'),
        url('capybara/cute-capibara-character-different-poses.png'),
        radial-gradient(circle at 10% 20%, rgba(156, 175, 136, 0.08) 0%, transparent 25%),
        radial-gradient(circle at 90% 80%, rgba(100, 181, 246, 0.08) 0%, transparent 25%);
      background-size: 200px auto, 180px auto, auto, auto;
      background-position: 2% 88%, 98% 88%, 0 0, 0 0;
      background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
      opacity: 0.3;
      pointer-events: none;
      z-index: 0;
    }

    h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 2.75rem;
      text-align: center;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--pink-dark), var(--pink-accent), var(--capybara-brown));
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }

    .tagline {
      text-align: center;
      font-size: 1rem;
      color: var(--capybara-brown);
      margin-bottom: 2rem;
      font-weight: 600;
      letter-spacing: 0.15em;
    }

    .tagline span { margin: 0 0.5rem; color: var(--nursing-blue); }

    .header-with-capybara {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .header-capybara {
      width: 80px;
      height: 80px;
      object-fit: contain;
      opacity: 0.9;
    }

    .header-capybara.left { transform: scaleX(-1); }

    .container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      position: relative;
      z-index: 1;
    }

    /* Message Card - nursing care vibes */
    .message-card {
      background: linear-gradient(145deg, var(--white), var(--nursing-soft));
      border-radius: 24px;
      padding: 1.75rem 2rem;
      box-shadow: 0 8px 32px var(--shadow), 0 0 0 1px rgba(100, 181, 246, 0.3);
      border: 2px solid var(--nursing-blue);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .message-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(233, 30, 140, 0.2);
    }

    .message-card h2 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      margin-bottom: 0.75rem;
      color: var(--nursing-blue);
      font-weight: 700;
    }

    .message-card h2::before { content: '‚ù§Ô∏è '; }

    .message-card textarea {
      width: 100%;
      min-height: 100px;
      padding: 1rem;
      border: 2px solid var(--nursing-light);
      border-radius: 16px;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      resize: vertical;
      transition: border-color 0.2s;
      background: var(--pink-light);
    }

    .message-card textarea:focus {
      outline: none;
      border-color: var(--nursing-blue);
      background: white;
    }

    .message-card textarea::placeholder {
      color: #c99ab0;
    }

    /* Photo Booth - capybara chill vibes */
    .photo-booth {
      background: linear-gradient(145deg, var(--white), rgba(156, 175, 136, 0.15));
      border-radius: 24px;
      padding: 1.75rem 2rem;
      box-shadow: 0 8px 32px var(--shadow), 0 0 0 1px rgba(139, 115, 85, 0.25);
      border: 2px solid var(--capybara-sage);
    }

    .photo-booth h2 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: var(--capybara-brown);
      font-weight: 700;
    }

    .photo-booth h2::before { content: 'üì∑ '; }

    .camera-container {
      position: relative;
      background: linear-gradient(145deg, #9CAF88 0%, #7CB342 50%, #64B5F6 100%);
      border-radius: 20px;
      overflow: hidden;
      aspect-ratio: 4/3;
      max-height: 400px;
      border: 3px solid var(--capybara-sage);
      box-shadow: inset 0 0 20px rgba(255,255,255,0.3), 0 4px 20px rgba(139, 115, 85, 0.2);
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(-1);
    }

    .camera-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      background: linear-gradient(145deg, #8B7355 0%, #7CB342 50%, #4DB6AC 100%);
      gap: 0.75rem;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .camera-placeholder.hidden {
      display: none;
    }

    .placeholder-capybara {
      width: 72px;
      height: 72px;
      object-fit: contain;
      opacity: 0.9;
    }

    .camera-placeholder svg {
      width: 48px;
      height: 48px;
      opacity: 0.7;
    }

    .controls {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .timer-options {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: auto;
    }

    .timer-options span {
      font-size: 0.85rem;
      color: var(--text);
      font-weight: 600;
    }

    .timer-btn {
      padding: 0.4rem 0.75rem;
      font-size: 0.85rem;
      border-radius: 12px;
      border: 2px solid var(--pink-mid);
      background: var(--pink-light);
      color: var(--pink-dark);
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .timer-btn:hover {
      background: var(--pink-mid);
      color: white;
    }

    .timer-btn.active {
      background: var(--pink-accent);
      border-color: var(--pink-dark);
      color: white;
    }

    .filter-options {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-options span {
      font-size: 0.85rem;
      color: var(--text);
      font-weight: 600;
    }

    .filter-btn {
      width: 44px;
      height: 44px;
      padding: 6px;
      border: 2px solid var(--pink-mid);
      border-radius: 12px;
      background: var(--pink-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      font-size: 1.2rem;
    }

    .filter-btn:hover {
      background: var(--pink-mid);
      transform: scale(1.05);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--pink-accent), var(--nursing-teal));
      border-color: var(--capybara-brown);
      box-shadow: 0 0 0 2px rgba(139, 115, 85, 0.3);
    }

    .filter-overlay-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
      display: none;
      transform: scaleX(-1);
    }

    .countdown-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: 20px;
    }

    .countdown-overlay.visible {
      display: flex;
    }

    .countdown-number {
      font-family: 'Quicksand', sans-serif;
      font-size: 5rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 0 20px rgba(233, 30, 140, 0.6);
      animation: countdown-pulse 1s ease-out;
    }

    @keyframes countdown-pulse {
      0% { transform: scale(0.5); opacity: 0; }
      30% { transform: scale(1.2); opacity: 1; }
      70% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1); opacity: 0.8; }
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 16px;
      font-family: 'Quicksand', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s, opacity 0.15s, box-shadow 0.15s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--pink-dark), var(--pink-accent));
      color: white;
      box-shadow: 0 4px 15px rgba(233, 30, 140, 0.4);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(233, 30, 140, 0.5);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ff85b3, #ffb3d0);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 133, 179, 0.4);
    }

    .btn-outline {
      background: transparent;
      color: var(--pink-dark);
      border: 2px solid var(--pink-accent);
    }

    .btn-outline:hover:not(:disabled) {
      background: var(--pink-light);
    }

    /* Gallery - blend */
    .gallery {
      background: linear-gradient(145deg, var(--white), rgba(156, 175, 136, 0.08));
      border-radius: 24px;
      padding: 1.75rem 2rem;
      box-shadow: 0 8px 32px var(--shadow), 0 0 0 1px rgba(139, 115, 85, 0.2);
      border: 2px solid var(--capybara-warm);
    }

    .gallery h2 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: var(--capybara-brown);
      font-weight: 700;
    }

    .gallery h2::before { content: 'üñºÔ∏è '; }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
    }

    .gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 15px var(--shadow);
      border: 2px solid var(--capybara-sage);
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .gallery-item .download-btn {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.5rem;
      background: linear-gradient(to top, rgba(233, 30, 140, 0.9), rgba(255, 133, 179, 0.9));
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      font-family: 'Quicksand', sans-serif;
    }

    .gallery-item:hover .download-btn {
      opacity: 1;
    }

    .gallery-empty {
      text-align: center;
      padding: 2rem;
      color: var(--pink-accent);
      font-style: italic;
    }

    /* Capture preview */
    #capture-preview {
      display: none;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #capture-preview.visible {
      display: block;
    }

    #video.hidden {
      display: none;
    }

    /* Love Letter Output - nursing care + pink */
    .love-letter-section {
      background: linear-gradient(145deg, #ffecf3, var(--nursing-soft));
      border-radius: 24px;
      padding: 1.75rem 2rem;
      box-shadow: 0 8px 32px var(--shadow), 0 0 0 1px rgba(100, 181, 246, 0.25);
      border: 2px solid var(--nursing-blue);
    }

    .love-letter-section h2 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: var(--nursing-blue);
      font-weight: 700;
    }

    .love-letter-section h2::before { content: 'üíå '; }

    /* Love letter card - paper/envelope styling */
    .love-letter-output {
      position: relative;
      max-width: 420px;
      margin: 0 auto;
      background: linear-gradient(180deg, #fffbfc 0%, #fff5f9 30%, #fff0f7 100%);
      border-radius: 4px;
      padding: 2.25rem 2rem;
      box-shadow:
        0 1px 3px rgba(139, 115, 85, 0.08),
        0 8px 24px rgba(233, 30, 140, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(233, 30, 140, 0.2);
      min-height: 380px;
      overflow: hidden;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .love-letter-output:hover {
      box-shadow:
        0 2px 6px rgba(139, 115, 85, 0.1),
        0 12px 32px rgba(233, 30, 140, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.95);
    }

    /* Decorative top edge - envelope flap feel */
    .love-letter-output::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 192, 217, 0.6) 20%,
        rgba(233, 30, 140, 0.25) 50%,
        rgba(255, 192, 217, 0.6) 80%,
        transparent 100%);
      pointer-events: none;
    }

    /* Inner vintage frame */
    .love-letter-output::after {
      content: '';
      position: absolute;
      inset: 12px;
      border: 1px solid rgba(139, 115, 85, 0.12);
      border-radius: 2px;
      pointer-events: none;
    }

    .love-letter-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.25rem;
      margin-top: 0.25rem;
    }

    .love-letter-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--capybara-brown);
      margin: 0;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(156, 175, 136, 0.4);
    }

    .love-letter-photos {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: center;
      width: 100%;
    }

    .love-letter-photo {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 100px;
      max-width: 140px;
      aspect-ratio: 4/3;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--capybara-sage);
      box-shadow:
        0 2px 8px rgba(139, 115, 85, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .love-letter-photo:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(139, 115, 85, 0.2);
    }

    .love-letter-photos-wrap {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .love-letter-photo-placeholder {
      width: 100%;
      max-width: 280px;
      padding: 2rem;
      background: linear-gradient(145deg, #fff5f9, #E8F5E9);
      border-radius: 12px;
      border: 2px dashed rgba(156, 175, 136, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--capybara-brown);
      font-style: italic;
      font-size: 0.9rem;
      text-align: center;
      opacity: 0.9;
    }

    /* Message area - handwritten letter feel */
    .love-letter-message {
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      line-height: 1.75;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
      text-align: center;
      padding: 1rem 1rem 0.5rem;
      min-height: 3.5em;
      background: linear-gradient(to bottom, transparent, rgba(255, 240, 245, 0.3));
      border-radius: 8px;
    }

    .love-letter-message.empty {
      color: #b8a4ad;
      font-style: italic;
    }

    .love-letter-actions {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .love-letter-actions .btn {
      box-shadow: 0 2px 8px rgba(233, 30, 140, 0.2);
    }

    .love-letter-actions .btn:hover:not(:disabled) {
      box-shadow: 0 4px 12px rgba(233, 30, 140, 0.3);
    }


    .gallery-item.selected {
      border-color: var(--pink-dark);
      box-shadow: 0 0 0 3px rgba(233, 30, 140, 0.3);
    }

    .gallery-item .delete-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(233, 30, 140, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 2;
    }

    .gallery-item:hover .delete-btn {
      opacity: 1;
    }

    .gallery-item .delete-btn:hover {
      transform: scale(1.1);
      background: #c2185b;
    }

    .confetti-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      animation: confetti-fall 1.5s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

  </style>
</head>
<body>
  <div class="header-with-capybara">
    <img src="capybara/cute-capibara-character-different-poses.png" alt="" class="header-capybara left" aria-hidden="true">
    <h1>Bea's Photo Booth</h1>
    <img src="capybara/cute-capibara-character-different-poses.png" alt="" class="header-capybara" aria-hidden="true">
  </div>
  <p class="tagline">Care <span>‚ô•</span> Chill <span>‚ô•</span> Capture</p>

  <div class="container">
    <!-- 1. Message Card -->
    <section class="message-card">
      <h2>Message Card</h2>
      <textarea id="message" placeholder="Write a note, caption, or message here..."></textarea>
    </section>

    <!-- 2. Photo Booth -->
    <section class="photo-booth">
      <h2>Photo Booth</h2>
      <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none"></canvas>
        <img id="capture-preview" alt="Capture preview">
        <canvas id="filter-overlay" class="filter-overlay-canvas"></canvas>
        <div class="countdown-overlay" id="countdown-overlay">
          <span class="countdown-number" id="countdown-number"></span>
        </div>
        <div id="confetti-container" class="confetti-container" style="display:none"></div>
        <div class="camera-placeholder" id="placeholder">
          <img src="capybara/cute-capibara-character-different-poses.png" alt="" class="placeholder-capybara" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          <span>Click "Start Camera" to begin</span>
        </div>
      </div>
      <div class="controls">
        <button class="btn btn-primary" id="start-btn">Start Camera</button>
        <button class="btn btn-secondary" id="capture-btn" disabled>Capture</button>
        <button class="btn btn-outline" id="retake-btn" disabled>Retake</button>
        <div class="filter-options">
          <span>Filters:</span>
          <button class="filter-btn active" data-filter="none" title="No filter">‚úï</button>
          <button class="filter-btn" data-filter="hearts" title="Hearts">‚ô•</button>
          <button class="filter-btn" data-filter="crown" title="Crown">‚ôî</button>
          <button class="filter-btn" data-filter="stars" title="Stars">‚ú¶</button>
        </div>
        <div class="timer-options">
          <span>Timer:</span>
          <button class="timer-btn active" data-timer="0">Off</button>
          <button class="timer-btn" data-timer="3">3 sec</button>
          <button class="timer-btn" data-timer="5">5 sec</button>
        </div>
      </div>
    </section>

    <!-- 3. Gallery & 4. Download -->
    <section class="gallery">
      <h2>Your Photos</h2>
      <p style="font-size: 0.85rem; color: var(--capybara-brown); margin-bottom: 0.5rem;">Click a photo to add or remove it from your love letter</p>
      <div class="gallery-grid" id="gallery"></div>
      <div class="gallery-empty" id="gallery-empty">No photos yet. Capture some memories!</div>
    </section>

    <!-- 5. Love Letter Output -->
    <section class="love-letter-section">
      <h2>üíå Your Love Letter</h2>

      <div class="love-letter-output" id="love-letter-card">
        <div class="love-letter-content">
          <p class="love-letter-title">With Love ‚úø Care ‚Ä¢ Chill</p>
          <div class="love-letter-photos-wrap">
            <div id="love-letter-photos" class="love-letter-photos"></div>
            <div id="love-letter-photo-placeholder" class="love-letter-photo-placeholder">Click photos above to add them to your love letter</div>
          </div>
          <p id="love-letter-message" class="love-letter-message empty">Write your message above...</p>
        </div>
      </div>
      <div class="love-letter-actions">
        <button class="btn btn-primary" id="download-love-letter-btn" disabled>Download Love Letter</button>
        <button class="btn btn-outline" id="share-love-letter-btn" disabled title="Share on mobile">Share</button>
      </div>
    </section>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const capturePreview = document.getElementById('capture-preview');
    const placeholder = document.getElementById('placeholder');
    const startBtn = document.getElementById('start-btn');
    const captureBtn = document.getElementById('capture-btn');
    const retakeBtn = document.getElementById('retake-btn');
    const gallery = document.getElementById('gallery');
    const galleryEmpty = document.getElementById('gallery-empty');
    const messageInput = document.getElementById('message');
    const loveLetterPhotos = document.getElementById('love-letter-photos');
    const loveLetterPhotoPlaceholder = document.getElementById('love-letter-photo-placeholder');
    const loveLetterMessage = document.getElementById('love-letter-message');
    const downloadLoveLetterBtn = document.getElementById('download-love-letter-btn');
    const shareLoveLetterBtn = document.getElementById('share-love-letter-btn');
    const loveLetterCard = document.getElementById('love-letter-card');
    const confettiContainer = document.getElementById('confetti-container');

    let stream = null;
    let capturedPhotos = [];
    let selectedPhotoIndices = [];
    let timerSeconds = 0;
    let countdownInterval = null;
    let currentFilter = 'none';
    let filterAnimationId = null;
    let faceLandmarker = null;
    let lastFacePosition = null;
    let lastVideoTime = -1;
    const filterOverlay = document.getElementById('filter-overlay');
    const cameraContainer = document.querySelector('.camera-container');

    const STORAGE_KEY = 'bea-photobooth-draft';

    function playShutterSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(1200, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.15, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      } catch (_) {}
    }

    function showConfettiBurst() {
      confettiContainer.style.display = 'block';
      confettiContainer.innerHTML = '';
      const symbols = ['‚ô•', '‚úø', '‚ú¶', '‚ô°', '‚ù§Ô∏è', '‚ûï', 'üåø', '‚Ä¢'];
      const colors = ['#e91e8c', '#ff85b3', '#9CAF88', '#64B5F6', '#ffd700', '#4DB6AC', '#7CB342', '#ff6b9d'];
      for (let i = 0; i < 35; i++) {
        const el = document.createElement('span');
        el.className = 'confetti-piece';
        el.textContent = symbols[Math.floor(Math.random() * symbols.length)];
        el.style.left = Math.random() * 100 + 'vw';
        el.style.fontSize = (14 + Math.random() * 20) + 'px';
        el.style.color = colors[Math.floor(Math.random() * colors.length)];
        el.style.animationDelay = Math.random() * 0.3 + 's';
        el.style.animationDuration = (1.2 + Math.random() * 0.6) + 's';
        confettiContainer.appendChild(el);
      }
      setTimeout(() => {
        confettiContainer.style.display = 'none';
        confettiContainer.innerHTML = '';
      }, 2000);
    }

    function loadDraft() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.message) messageInput.value = data.message;
        }
      } catch (_) {}
    }

    function saveDraft() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          message: messageInput.value,
          savedAt: Date.now()
        }));
      } catch (_) {}
    }

    async function initFaceLandmarker() {
      if (faceLandmarker) return true;
      try {
        const vision = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs');
        const { FaceLandmarker, FilesetResolver } = vision;
        const filesetResolver = await FilesetResolver.forVisionTasks(
          'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'
        );
        try {
          faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
            baseOptions: {
              modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
              delegate: 'GPU'
            },
            runningMode: 'VIDEO',
            numFaces: 1
          });
        } catch (gpuErr) {
          faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
            baseOptions: {
              modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
              delegate: 'CPU'
            },
            runningMode: 'VIDEO',
            numFaces: 1
          });
        }
        return true;
      } catch (e) {
        console.warn('Face tracking unavailable:', e);
        return false;
      }
    }

    function detectFace() {
      if (!faceLandmarker || !video.videoWidth || video.readyState < 2) return null;
      try {
        const now = performance.now();
        if (lastVideoTime === video.currentTime) return lastFacePosition;
        lastVideoTime = video.currentTime;
        const results = faceLandmarker.detectForVideo(video, now);
        if (!results.faceLandmarks || results.faceLandmarks.length === 0) return lastFacePosition;
        const landmarks = results.faceLandmarks[0];
        let minY = 1, cx = 0.5;
        for (let i = 0; i < Math.min(landmarks.length, 100); i++) {
          const l = landmarks[i];
          if (l.y < minY) {
            minY = l.y;
            cx = l.x;
          }
        }
        lastFacePosition = { x: cx, y: Math.max(0, minY - 0.08) };
        return lastFacePosition;
      } catch (e) {
        return lastFacePosition;
      }
    }

    // Filter selection
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        if (currentFilter === 'none' && filterAnimationId) {
          cancelAnimationFrame(filterAnimationId);
          filterAnimationId = null;
        } else if (stream) {
          startFilterLoop();
        }
      });
    });

    function drawFilter(ctx, w, h, faceCenter) {
      const cx = faceCenter ? faceCenter.x * w : w / 2;
      const cy = faceCenter ? faceCenter.y * h : h * 0.35;
      const t = Date.now() / 1000;

      if (currentFilter === 'hearts') {
        const positions = [[0, -1.2], [-0.6, -0.8], [0.6, -0.8], [-0.3, -1.5], [0.3, -1.5]];
        const scale = Math.min(w, h) * 0.12;
        positions.forEach(([ox, oy], i) => {
          const x = cx + ox * scale;
          const y = cy + oy * scale + Math.sin(t * 2 + i) * 4;
          const s = scale * (0.8 + Math.sin(t + i * 0.5) * 0.2);
          ctx.font = `${s}px Arial`;
          ctx.fillStyle = `rgba(233, 30, 140, ${0.7 + Math.sin(t * 3) * 0.2})`;
          ctx.fillText('‚ô•', x - s / 2, y + s / 2);
        });
      } else if (currentFilter === 'crown') {
        const scale = Math.min(w, h) * 0.08;
        const pts = [[-1.5, 0.5], [-0.8, -0.3], [0, 0.2], [0.8, -0.3], [1.5, 0.5]];
        ctx.strokeStyle = '#ffd700';
        ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        pts.forEach(([px, py], i) => {
          const x = cx + px * scale;
          const y = cy + py * scale;
          ctx[i === 0 ? 'moveTo' : 'lineTo'](x, y);
        });
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
      } else if (currentFilter === 'stars') {
        const positions = [[0, -1], [-0.5, -0.5], [0.5, -0.5], [-0.8, -1.2], [0.8, -1.2]];
        const scale = Math.min(w, h) * 0.1;
        positions.forEach(([ox, oy], i) => {
          const x = cx + ox * scale + Math.cos(t + i) * 3;
          const y = cy + oy * scale;
          const s = scale * (0.6 + Math.sin(t * 2 + i) * 0.3);
          ctx.font = `${s}px Arial`;
          ctx.fillStyle = `rgba(255, 215, 0, ${0.8 + Math.sin(t * 4) * 0.2})`;
          ctx.fillText('‚ú¶', x - s / 2, y + s / 2);
        });
      }
    }

    // Map video-normalized (0-1) coords to overlay pixels, accounting for object-fit: cover
    function videoNormToOverlay(xNorm, yNorm, overlayW, overlayH, videoW, videoH) {
      if (!videoW || !videoH) return { x: overlayW / 2, y: overlayH * 0.35 };
      const scale = Math.max(overlayW / videoW, overlayH / videoH);
      const scaledW = videoW * scale;
      const scaledH = videoH * scale;
      const offsetX = (scaledW - overlayW) / 2;
      const offsetY = (scaledH - overlayH) / 2;
      const visibleNormX = (xNorm * scaledW - offsetX) / overlayW;
      const visibleNormY = (yNorm * scaledH - offsetY) / overlayH;
      return {
        x: visibleNormX * overlayW,
        y: visibleNormY * overlayH
      };
    }

    function runFilterLoop() {
      if (!stream || currentFilter === 'none' || !filterOverlay) return;
      const rect = cameraContainer.getBoundingClientRect();
      if (filterOverlay.width !== rect.width || filterOverlay.height !== rect.height) {
        filterOverlay.width = rect.width;
        filterOverlay.height = rect.height;
      }
      const ctx = filterOverlay.getContext('2d');
      ctx.clearRect(0, 0, filterOverlay.width, filterOverlay.height);
      let facePos = null;
      if (faceLandmarker) {
        const raw = detectFace();
        if (raw) {
          const mapped = videoNormToOverlay(raw.x, raw.y, filterOverlay.width, filterOverlay.height, video.videoWidth, video.videoHeight);
          facePos = { x: mapped.x / filterOverlay.width, y: mapped.y / filterOverlay.height };
        }
      }
      drawFilter(ctx, filterOverlay.width, filterOverlay.height, facePos);
      filterAnimationId = requestAnimationFrame(runFilterLoop);
    }

    async function startFilterLoop() {
      if (filterAnimationId) cancelAnimationFrame(filterAnimationId);
      if (currentFilter !== 'none' && stream) {
        await initFaceLandmarker();
        filterOverlay.style.display = 'block';
        lastFacePosition = null;
        lastVideoTime = -1;
        runFilterLoop();
      } else {
        filterOverlay.style.display = 'none';
      }
    }

    function stopFilterLoop() {
      if (filterAnimationId) {
        cancelAnimationFrame(filterAnimationId);
        filterAnimationId = null;
      }
      filterOverlay.style.display = 'none';
    }

    // Timer options
    document.querySelectorAll('.timer-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.timer-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        timerSeconds = parseInt(btn.dataset.timer, 10);
      });
    });

    // Start camera
    startBtn.addEventListener('click', async () => {
      try {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: 'user',
              width: { ideal: 1920, min: 1280 },
              height: { ideal: 1080, min: 720 }
            }
          });
        } catch (resErr) {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        }
        video.srcObject = stream;
        placeholder.classList.add('hidden');
        captureBtn.disabled = false;
        startBtn.textContent = 'Camera On';
        startBtn.disabled = true;
        if (currentFilter !== 'none') startFilterLoop();
      } catch (err) {
        alert('Could not access camera. Please allow camera permissions.');
        console.error(err);
      }
    });

    function doCapture() {
      stopFilterLoop();
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      ctx.restore();
      if (currentFilter !== 'none') {
        const facePos = lastFacePosition ? { x: lastFacePosition.x, y: lastFacePosition.y } : null;
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        drawFilter(ctx, video.videoWidth, video.videoHeight, facePos);
        ctx.restore();
      }
      const dataUrl = canvas.toDataURL('image/png');
      capturedPhotos.push(dataUrl);
      selectedPhotoIndices.push(capturedPhotos.length - 1);

      playShutterSound();
      showConfettiBurst();

      capturePreview.src = dataUrl;
      capturePreview.classList.add('visible');
      video.classList.add('hidden');
      captureBtn.disabled = true;
      retakeBtn.disabled = false;
      
      renderGallery();
      updateLoveLetter();
    }

    // Capture photo (with optional timer)
    captureBtn.addEventListener('click', () => {
      if (timerSeconds === 0) {
        doCapture();
        return;
      }

      captureBtn.disabled = true;
      const countdownOverlay = document.getElementById('countdown-overlay');
      const countdownNumber = document.getElementById('countdown-number');
      let count = timerSeconds;

      countdownOverlay.classList.add('visible');
      countdownNumber.textContent = count;

      countdownInterval = setInterval(() => {
        count--;
        countdownNumber.textContent = count;
        if (count <= 0) {
          clearInterval(countdownInterval);
          countdownOverlay.classList.remove('visible');
          doCapture();
          captureBtn.disabled = false;
        }
      }, 1000);
    });

    // Retake
    retakeBtn.addEventListener('click', () => {
      capturePreview.classList.remove('visible');
      capturePreview.src = '';
      video.classList.remove('hidden');
      captureBtn.disabled = false;
      retakeBtn.disabled = true;
      if (currentFilter !== 'none') startFilterLoop();
    });

    // Render gallery with download buttons
    function renderGallery() {
      galleryEmpty.style.display = capturedPhotos.length ? 'none' : 'block';
      gallery.innerHTML = '';

      capturedPhotos.forEach((photo, i) => {
        const isInLoveLetter = selectedPhotoIndices.includes(i);
        const item = document.createElement('div');
        item.className = 'gallery-item' + (isInLoveLetter ? ' selected' : '');
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('download-btn') && !e.target.classList.contains('delete-btn')) {
            const idx = selectedPhotoIndices.indexOf(i);
            if (idx >= 0) {
              selectedPhotoIndices.splice(idx, 1);
            } else {
              selectedPhotoIndices.push(i);
              selectedPhotoIndices.sort((a, b) => a - b);
            }
            renderGallery();
            updateLoveLetter();
          }
        });
        const img = document.createElement('img');
        img.src = photo;
        img.alt = `Photo ${i + 1}`;
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '√ó';
        deleteBtn.title = 'Delete photo';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = selectedPhotoIndices.indexOf(i);
          if (idx >= 0) selectedPhotoIndices.splice(idx, 1);
          selectedPhotoIndices = selectedPhotoIndices.map(x => x > i ? x - 1 : x).filter(x => x >= 0);
          capturedPhotos.splice(i, 1);
          renderGallery();
          updateLoveLetter();
        });
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'download-btn';
        downloadBtn.textContent = 'Download';
        downloadBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          downloadPhoto(photo, `bea-photo-${i + 1}.png`);
        });
        item.appendChild(img);
        item.appendChild(deleteBtn);
        item.appendChild(downloadBtn);
        gallery.appendChild(item);
      });
    }

    // Update love letter preview
    function updateLoveLetter() {
      const msg = messageInput.value.trim();
      loveLetterMessage.textContent = msg || 'Write your message above...';
      loveLetterMessage.classList.toggle('empty', !msg);

      loveLetterPhotos.innerHTML = '';
      const hasPhotos = selectedPhotoIndices.length > 0;
      loveLetterPhotoPlaceholder.style.display = hasPhotos ? 'none' : 'flex';

      selectedPhotoIndices.forEach(idx => {
        if (capturedPhotos[idx]) {
          const img = document.createElement('img');
          img.className = 'love-letter-photo';
          img.src = capturedPhotos[idx];
          img.alt = 'Love letter photo';
          loveLetterPhotos.appendChild(img);
        }
      });

      downloadLoveLetterBtn.disabled = !(msg || hasPhotos);
      shareLoveLetterBtn.disabled = !(msg || hasPhotos);
    }
    if (!('share' in navigator)) {
      shareLoveLetterBtn.style.display = 'none';
    }

    // Share love letter (Web Share API - mobile)
    shareLoveLetterBtn.addEventListener('click', async () => {
      if (typeof html2canvas === 'undefined' || !navigator.share) return;
      html2canvas(loveLetterCard, {
        backgroundColor: null,
        scale: 3,
        useCORS: true,
        logging: false
      }).then(async cvs => {
        cvs.toBlob(async (blob) => {
          const file = new File([blob], 'bea-love-letter.png', { type: 'image/png' });
          try {
            await navigator.share({
              title: "Bea's Love Letter",
              files: [file]
            });
          } catch (e) {
            if (e.name !== 'AbortError') downloadLoveLetterBtn.click();
          }
        }, 'image/png');
      });
    });

    // Download love letter as image
    downloadLoveLetterBtn.addEventListener('click', () => {
      if (typeof html2canvas === 'undefined') {
        alert('Please wait for the page to load completely.');
        return;
      }
      html2canvas(loveLetterCard, {
        backgroundColor: null,
        scale: 3,
        useCORS: true,
        logging: false
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'bea-love-letter.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    });

    messageInput.addEventListener('input', () => {
      updateLoveLetter();
      saveDraft();
    });

    loadDraft();
    updateLoveLetter();

    function downloadPhoto(dataUrl, filename) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      a.click();
    }

    // Stop camera when leaving
    window.addEventListener('beforeunload', () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
    });
  </script>
</body>
</html>
